<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Liquor Inventory App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    video { border: 1px solid #ccc; width: 400px; height: 300px; }
    table { border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    button { margin: 5px; padding: 10px; }
    #waitingMessage { margin-top: 10px; color: red; }
  </style>
</head>
<body>
  <h1>Liquor Inventory App</h1>

  <video id="camera" autoplay playsinline></video>
  <br>
  <button id="switchCamera">Switch Camera</button>
  <button id="resetCamera">Reset</button>
  <button id="scanItem">Scan Item</button>
  <p id="waitingMessage">Waiting for model...</p>

  <h2>Scan Log (Last 10)</h2>
  <table id="scanLog">
    <thead>
      <tr>
        <th>#</th>
        <th>Item</th>
        <th>Confidence</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <!-- Teachable Machine helper -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <script>
    let model;
    let labels = [];
    let scanHistory = [];
    let currentStream;
    let usingFrontCamera = true;

    const video = document.getElementById("camera");
    const waitingMessage = document.getElementById("waitingMessage");

    async function init() {
      const modelURL = "model/model.json";
      const metadataURL = "model/metadata.json";

      try {
        console.log("Loading model...");
        model = await tmImage.load(modelURL, metadataURL);
        labels = model.getClassLabels();
        console.log("âœ… Model loaded with labels:", labels);
        waitingMessage.style.display = "none";
      } catch (err) {
        console.error("âŒ Failed to load model:", err);
        waitingMessage.textContent = "Failed to load model. Check console.";
      }

      await startCamera();
    }

    async function startCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        video: { facingMode: usingFrontCamera ? "user" : "environment" }
      };

      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        console.log("ðŸ“· Camera started:", usingFrontCamera ? "Front" : "Rear");
      } catch (err) {
        console.error("âŒ Error accessing camera:", err);
      }
    }

    async function scanItem() {
      if (!model) {
        console.warn("âš ï¸ Model not loaded yet.");
        return;
      }

      try {
        const predictions = await model.predict(video);
        const topPrediction = predictions.reduce((a, b) =>
          a.probability > b.probability ? a : b
        );

        const itemName = topPrediction.className;
        const confidence = (topPrediction.probability * 100).toFixed(1) + "%";
        const timestamp = new Date().toLocaleTimeString();

        scanHistory.unshift({ item: itemName, confidence, timestamp });
        if (scanHistory.length > 10) scanHistory.pop();

        updateLog();
      } catch (err) {
        console.error("âŒ Prediction failed:", err);
      }
    }

    function updateLog() {
      const tbody = document.querySelector("#scanLog tbody");
      tbody.innerHTML = "";
      scanHistory.forEach((entry, idx) => {
        const row = `
          <tr>
            <td>${idx + 1}</td>
            <td>${entry.item}</td>
            <td>${entry.confidence}</td>
            <td>${entry.timestamp}</td>
          </tr>`;
        tbody.innerHTML += row;
      });
    }

    document.getElementById("switchCamera").addEventListener("click", async () => {
      usingFrontCamera = !usingFrontCamera;
      await startCamera();
    });

    document.getElementById("resetCamera").addEventListener("click", async () => {
      await startCamera();
    });

    document.getElementById("scanItem").addEventListener("click", scanItem);

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
