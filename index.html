<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Liquor Bottle AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background: #f8f8f8; }
    #webcam-container canvas { width: 90%; max-width: 500px; border-radius: 12px; border: 2px solid #333; margin-top: 10px; }
    #label-container { margin-top: 20px; font-size: 1.1em; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; }
    button, select { padding: 12px 16px; font-size: 1rem; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    .progress-bar { width: 100%; background-color: #ddd; border-radius: 10px; margin-top: 5px; height: 18px; }
    .progress-fill { height: 100%; background-color: #4CAF50; border-radius: 10px; width: 0%; text-align: right; padding-right: 5px; color: white; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Liquor Bottle AI Test</h1>
  <p>Select camera and tap "Start Camera" to scan a bottle.</p>

  <label for="cameraSelect">Camera:</label>
  <select id="cameraSelect">
    <option value="environment" selected>Rear</option>
    <option value="user">Front</option>
  </select>
  <br>
  <button id="startBtn">Start Camera</button>
  <button id="refreshBtn">Refresh Camera</button>

  <div id="webcam-container"></div>
  <div id="label-container"></div>

  <!-- TensorFlow.js + Teachable Machine scripts (versioned) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

  <script>
    const URL = "./model/"; // model folder path
    let model, webcam, labelContainer, maxPredictions;

    async function init(facingMode = "environment") {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      try {
        if (!model) model = await tmImage.load(modelURL, metadataURL);
      } catch (err) {
        alert("Error loading model: " + err.message);
        return;
      }

      maxPredictions = model.getTotalClasses();

      // Stop previous webcam if exists
      if (webcam) {
        webcam.stop();
        document.getElementById("webcam-container").innerHTML = "";
      }

      // Initialize webcam with selected camera
      webcam = new tmImage.Webcam(480, 360, false, { facingMode });
      try {
        await webcam.setup();
        await webcam.play();
      } catch (err) {
        alert("Unable to access selected camera: " + err.message);
        return;
      }
      window.requestAnimationFrame(loop);

      document.getElementById("webcam-container").appendChild(webcam.canvas);

      // Setup progress bars if not already present
      labelContainer = document.getElementById("label-container");
      if (labelContainer.childNodes.length === 0) {
        for (let i = 0; i < maxPredictions; i++) {
          const labelDiv = document.createElement("div");
          const progressDiv = document.createElement("div");
          progressDiv.className = "progress-bar";
          const fillDiv = document.createElement("div");
          fillDiv.className = "progress-fill";
          progressDiv.appendChild(fillDiv);
          labelDiv.appendChild(progressDiv);
          labelContainer.appendChild(labelDiv);
        }
      }
    }

    async function loop() {
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      prediction.sort((a, b) => b.probability - a.probability);

      for (let i = 0; i < prediction.length; i++) {
        const fillDiv = labelContainer.childNodes[i].querySelector(".progress-fill");
        const pct = (prediction[i].probability * 100).toFixed(1);
        fillDiv.style.width = pct + "%";
        fillDiv.textContent = `${prediction[i].className} ${pct}%`;
      }
    }

    const startBtn = document.getElementById("startBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const cameraSelect = document.getElementById("cameraSelect");

    startBtn.addEventListener("click", async () => {
      startBtn.disabled = true;
      await init(cameraSelect.value);
    });

    refreshBtn.addEventListener("click", async () => {
      await init(cameraSelect.value);
    });
  </script>
</body>
</html>
