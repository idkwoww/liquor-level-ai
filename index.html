<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bottle Level Detector</title>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <!-- Teachable Machine (correct CDN that exposes tmImage) -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    video { width: 90%; max-width: 400px; margin: 10px auto; border: 2px solid #333; border-radius: 8px; }
    #label-container { margin-top: 20px; font-size: 1.2em; font-weight: bold; }
    select, button { margin: 10px; padding: 10px; font-size: 1em; }
  </style>
</head>
<body>
  <h1>Bottle Level Detector</h1>

  <label for="cameraSelect">Choose Camera:</label>
  <select id="cameraSelect"></select>
  <br>
  <button onclick="switchCamera()">Switch Camera</button>
  <button onclick="reset()">Reset</button>

  <div><video id="webcam" autoplay playsinline muted></video></div>
  <div id="label-container">Loading model...</div>

  <script>
    const URL = "https://USERNAME.github.io/REPONAME/model/"; // ðŸ”¹ Replace USERNAME & REPONAME
    let model, webcam, labelContainer, maxPredictions;
    let currentStream;
    let selectedDeviceId = null;

    async function init() {
      try {
        // Load model + metadata
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = "Model loaded. Starting camera...";

        await setupCameraSelection();
      } catch (err) {
        console.error("Model failed to load:", err);
        labelContainer.innerHTML = "Model failed to load.";
      }
    }

    async function setupCameraSelection() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === "videoinput");

      const cameraSelect = document.getElementById("cameraSelect");
      cameraSelect.innerHTML = "";

      // Show only 1 front + 1 back
      const seen = new Set();
      videoDevices.forEach(device => {
        const label = device.label.toLowerCase();
        if ((label.includes("back") || label.includes("rear")) && !seen.has("rear")) {
          seen.add("rear");
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.text = "Rear Camera";
          cameraSelect.appendChild(option);
        } else if ((label.includes("front") || label.includes("user")) && !seen.has("front")) {
          seen.add("front");
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.text = "Front Camera";
          cameraSelect.appendChild(option);
        }
      });

      if (cameraSelect.options.length === 0) {
        videoDevices.forEach(device => {
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.text = device.label || `Camera ${cameraSelect.options.length + 1}`;
          cameraSelect.appendChild(option);
        });
      }

      cameraSelect.onchange = () => {
        selectedDeviceId = cameraSelect.value;
        startCamera(selectedDeviceId);
      };

      if (cameraSelect.options.length > 0) {
        selectedDeviceId = cameraSelect.options[0].value;
        startCamera(selectedDeviceId);
      }
    }

    async function startCamera(deviceId) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      try {
        const constraints = {
          video: { deviceId: deviceId ? { exact: deviceId } : undefined }
        };

        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById("webcam");
        video.srcObject = currentStream;
        video.onloadedmetadata = () => {
          video.play();
          loop();
        };

        labelContainer.innerHTML = "Camera started. Detecting...";
      } catch (err) {
        console.error("Camera start error:", err);
        labelContainer.innerHTML = "Unable to access camera.";
      }
    }

    async function loop() {
      const video = document.getElementById("webcam");
      if (model && video.readyState === 4) {
        const prediction = await model.predict(video);
        let best = prediction[0];
        prediction.forEach(p => { if (p.probability > best.probability) best = p; });
        labelContainer.innerHTML = `${best.className} (${(best.probability * 100).toFixed(1)}%)`;
      }
      requestAnimationFrame(loop);
    }

    function switchCamera() {
      const cameraSelect = document.getElementById("cameraSelect");
      if (cameraSelect.options.length > 1) {
        cameraSelect.selectedIndex = (cameraSelect.selectedIndex + 1) % cameraSelect.options.length;
        selectedDeviceId = cameraSelect.value;
        startCamera(selectedDeviceId);
      }
    }

    function reset() {
      labelContainer.innerHTML = "Reset. Choose a camera to start again.";
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
    }

    window.onload = init;
  </script>
</body>
</html>
