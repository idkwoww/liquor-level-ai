<!DOCTYPE html>
<html>
<head>
  <title>Liquor Bottle AI Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    video { border: 2px solid #333; border-radius: 8px; margin-top: 10px; }
    #status { margin: 15px; font-weight: bold; color: darkblue; }
  </style>
</head>
<body>
  <h1>Liquor Bottle AI Test</h1>
  
  <!-- Video -->
  <video id="webcam" autoplay playsinline width="400" height="300"></video>
  
  <!-- Buttons -->
  <div>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
  </div>
  
  <!-- Status + Output -->
  <div id="status">Idle</div>
  <div id="output"></div>
  
  <script>
    const modelURL = "model/";
    let model, webcamStream, recording = false;
    let predictionsLog = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusDiv = document.getElementById("status");

    async function initModel() {
      if (!model) {
        statusDiv.textContent = "Loading model...";
        try {
          model = await tmImage.load(modelURL + "model.json", modelURL + "metadata.json");
          statusDiv.textContent = "Model loaded.";
        } catch (err) {
          statusDiv.textContent = "Error loading model: " + err.message;
          throw err;
        }
      }
    }

    async function startRecording() {
      await initModel();

      const constraints = {
        audio: false,
        video: { facingMode: { ideal: "environment" } } // rear preferred
      };

      try {
        const webcamElement = document.getElementById("webcam");
        webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
        webcamElement.srcObject = webcamStream;

        await new Promise(resolve => {
          webcamElement.onloadedmetadata = () => {
            webcamElement.play();
            resolve();
          };
        });

        recording = true;
        predictionsLog = [];
        statusDiv.textContent = "Recording...";

        startBtn.disabled = true;
        stopBtn.disabled = false;

        runPredictionLoop();
      } catch (err) {
        statusDiv.textContent = "Camera error: " + err.message;
        console.error(err);
      }
    }

    async function runPredictionLoop() {
      const webcamElement = document.getElementById("webcam");

      while (recording) {
        if (webcamElement.readyState === 4) {
          try {
            const prediction = await model.predict(webcamElement);

            let result = {};
            prediction.forEach(p => {
              result[p.className] = p.probability;
            });
            predictionsLog.push(result);
          } catch (err) {
            console.error("Prediction error:", err);
          }
        }
        await new Promise(resolve => setTimeout(resolve, 300)); // ~3 fps
      }
    }

    function stopRecording() {
      recording = false;
      if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
      }

      startBtn.disabled = false;
      stopBtn.disabled = true;
      statusDiv.textContent = "Stopped.";

      const outputDiv = document.getElementById("output");
      outputDiv.innerHTML = "<h3>Results:</h3>";

      if (predictionsLog.length === 0) {
        outputDiv.innerHTML += "<p>No predictions recorded.</p>";
        return;
      }

      let totals = {};
      predictionsLog.forEach(pred => {
        for (let label in pred) {
          totals[label] = (totals[label] || 0) + pred[label];
        }
      });

      let averages = {};
      for (let label in totals) {
        averages[label] = (totals[label] / predictionsLog.length * 100).toFixed(2);
      }

      for (let label in averages) {
        outputDiv.innerHTML += `<p>${label}: ${averages[label]}%</p>`;
      }

      console.log("Recording stopped. Results:", averages);
    }

    // Attach event listeners
    startBtn.addEventListener("click", startRecording);
    stopBtn.addEventListener("click", stopRecording);
  </script>
</body>
</html>
