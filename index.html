<!DOCTYPE html>
<html>
<head>
  <title>Liquor Bottle AI Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image"></script>
</head>
<body>
  <h1>Liquor Bottle AI Test</h1>
  
  <!-- Video -->
  <video id="webcam" autoplay playsinline width="400" height="300"></video>
  
  <!-- Buttons -->
  <div>
    <button onclick="startRecording()">Start Recording</button>
    <button onclick="stopRecording()">Stop Recording</button>
  </div>
  
  <!-- Output -->
  <div id="output"></div>
  
  <script>
    const modelURL = "model/";
    let model, webcamStream, recording = false;
    let predictionsLog = [];

    async function initModel() {
      if (!model) {
        model = await tmImage.load(modelURL + "model.json", modelURL + "metadata.json");
        console.log("Model loaded.");
      }
    }

    async function startRecording() {
      await initModel();

      const constraints = {
        audio: false,
        video: { facingMode: "environment" } // try rear, fallback front
      };

      try {
        const webcamElement = document.getElementById("webcam");
        webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
        webcamElement.srcObject = webcamStream;

        // Wait for video to be ready
        await new Promise(resolve => {
          webcamElement.onloadedmetadata = () => {
            webcamElement.play();
            resolve();
          };
        });

        recording = true;
        predictionsLog = [];
        runPredictionLoop();
        console.log("Recording started.");
      } catch (err) {
        alert("Camera error: " + err.message);
        console.error(err);
      }
    }

    async function runPredictionLoop() {
      const webcamElement = document.getElementById("webcam");

      while (recording) {
        if (webcamElement.readyState === 4) {
          const prediction = await model.predict(webcamElement);

          let result = {};
          prediction.forEach(p => {
            result[p.className] = p.probability;
          });
          predictionsLog.push(result);
        }
        await new Promise(resolve => setTimeout(resolve, 200)); // ~5 fps
      }
    }

    function stopRecording() {
      recording = false;
      if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
      }

      const outputDiv = document.getElementById("output");
      outputDiv.innerHTML = "<h3>Results:</h3>";

      if (predictionsLog.length === 0) {
        outputDiv.innerHTML += "<p>No predictions recorded.</p>";
        return;
      }

      let totals = {};
      predictionsLog.forEach(pred => {
        for (let label in pred) {
          totals[label] = (totals[label] || 0) + pred[label];
        }
      });

      let averages = {};
      for (let label in totals) {
        averages[label] = (totals[label] / predictionsLog.length * 100).toFixed(2);
      }

      for (let label in averages) {
        outputDiv.innerHTML += `<p>${label}: ${averages[label]}%</p>`;
      }

      console.log("Recording stopped. Results:", averages);
    }
  </script>
</body>
</html>
