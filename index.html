const URL = "model/"; // make sure your model folder is at /model in GitHub

let model, webcam, labelContainer, maxPredictions;
let currentStream = null;

// Initialize the model and webcam
async function init(cameraId = null) {
  const modelURL = URL + "model.json";
  const metadataURL = URL + "metadata.json";

  // Load the model
  model = await tmImage.load(modelURL, metadataURL);
  maxPredictions = model.getTotalClasses();

  // Setup webcam
  const flip = false; // no flip by default
  const constraints = {
    video: cameraId ? { deviceId: cameraId } : true
  };
  webcam = new tmImage.Webcam(400, 400, flip);
  await webcam.setup(constraints);
  await webcam.play();

  // Attach webcam to video
  document.getElementById("webcam").srcObject = webcam.webcam;
  window.requestAnimationFrame(loop);

  // Setup label container
  labelContainer = document.getElementById("label-container");
  labelContainer.innerHTML = "";
  for (let i = 0; i < maxPredictions; i++) {
    labelContainer.appendChild(document.createElement("div"));
  }
}

async function loop() {
  webcam.update();
  await predict();
  window.requestAnimationFrame(loop);
}

async function predict() {
  const prediction = await model.predict(webcam.canvas);
  prediction.sort((a, b) => b.probability - a.probability);
  
  // Show top prediction
  const top = prediction[0];
  labelContainer.childNodes[0].innerHTML = 
    `${top.className}: ${(top.probability * 100).toFixed(1)}%`;
}

// Camera dropdown setup
async function setupCameraOptions() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(d => d.kind === "videoinput");

  const select = document.getElementById("cameraSelect");
  select.innerHTML = "";

  videoDevices.forEach((device, index) => {
    const option = document.createElement("option");
    option.value = device.deviceId;
    option.text = device.label || `Camera ${index + 1}`;
    select.appendChild(option);
  });

  select.onchange = () => {
    switchCamera(select.value);
  };
}

async function switchCamera(cameraId) {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
  }
  await init(cameraId);
}

// Reset button
document.getElementById("reset").onclick = () => {
  labelContainer.innerHTML = "";
};

// Start everything
setupCameraOptions().then(() => init());
