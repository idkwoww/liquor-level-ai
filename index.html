<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bottle Level Detector</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    video { width: 300px; height: auto; border: 1px solid black; margin-top: 10px; }
    #label-container { margin-top: 20px; font-size: 20px; font-weight: bold; }
    select, button { margin: 10px; padding: 8px; }
  </style>
</head>
<body>
  <h1>Bottle Level Detector</h1>

  <label for="cameraSelect">Choose camera:</label>
  <select id="cameraSelect">
    <option value="user">Front Camera</option>
    <option value="environment">Rear Camera</option>
  </select>
  <button onclick="refreshCamera()">Switch Camera</button>

  <br><br>
  <video id="webcam" autoplay playsinline muted></video>

  <div id="label-container">Waiting for camera...</div>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <!-- Local Teachable Machine -->
  <script src="teachablemachine-image.min.js"></script>

  <script>
    const modelURL = "model/model.json";
    const metadataURL = "model/metadata.json";
    let model, webcamStream, labelContainer;

    // Keep a rolling history of last 10 predictions for smoothing
    let predictionHistory = [];

    async function init() {
      model = await tmImage.load(modelURL, metadataURL);
      labelContainer = document.getElementById("label-container");

      // Default: front camera
      startCamera("user");
    }

    async function startCamera(facingMode) {
      if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        video: { facingMode: facingMode }
      };

      try {
        webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElement = document.getElementById("webcam");
        videoElement.srcObject = webcamStream;

        videoElement.onloadeddata = () => {
          predictLoop(videoElement);
        };
      } catch (err) {
        alert("Camera error: " + err.message);
      }
    }

    async function refreshCamera() {
      const select = document.getElementById("cameraSelect");
      startCamera(select.value);
    }

    async function predictLoop(videoElement) {
      while (true) {
        const prediction = await model.predict(videoElement);

        // Find the most confident prediction
        let best = prediction[0];
        for (let p of prediction) {
          if (p.probability > best.probability) {
            best = p;
          }
        }

        // Add to history (keep last 10)
        predictionHistory.push(best);
        if (predictionHistory.length > 10) {
          predictionHistory.shift();
        }

        // Compute average probability for the current best class
        const sameClassPreds = predictionHistory.filter(p => p.className === best.className);
        const avgProb = sameClassPreds.reduce((sum, p) => sum + p.probability, 0) / sameClassPreds.length;

        const percent = (avgProb * 100).toFixed(2);
        labelContainer.innerHTML = `Most likely: ${best.className} (${percent}%)`;

        await tf.nextFrame();
      }
    }

    init();
  </script>
</body>
</html>
